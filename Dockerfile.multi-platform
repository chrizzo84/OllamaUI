# Alternative Dockerfile mit Multi-Platform Support
# WICHTIG: vorher wurde --platform=$BUILDPLATFORM genutzt -> native Module (better-sqlite3)
# wurden für die Build-Arch kompiliert und dann in ein Image für eine andere Target-Arch kopiert.
# Dadurch kam es zu 'illegal instruction' / 'wrong ELF class' Fehlern.
# Lösung: Wir lassen jede Stage auf der Target Plattform laufen (buildx erledigt das pro Arch automatisch)
# und führen zusätzlich im finalen Stage einen Rebuild durch, falls nötig.
FROM node:20-bullseye-slim AS deps
WORKDIR /build

# Install build dependencies for native modules
RUN apt-get update && apt-get install -y \
    python3 \
    make \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Install pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

# Copy package files
COPY ollama-ui/package.json ollama-ui/pnpm-lock.yaml ./ollama-ui/
WORKDIR /build/ollama-ui

# Install dependencies
RUN pnpm install --frozen-lockfile

# ---------- Build stage: compile Next.js app ----------
FROM deps AS builder
# Copy source
COPY ollama-ui .

# Rebuild native Module explizit für die (jetzt korrekte) Target-Plattform
RUN pnpm rebuild better-sqlite3 || (echo 'Rebuild failed, attempting clean build' >&2; rm -rf node_modules/.pnpm/better-sqlite3* && pnpm rebuild better-sqlite3)

# Build app
ENV NEXT_TELEMETRY_DISABLED=1
RUN pnpm build

# ---------- Runtime stage: base Ollama image + UI ----------
FROM ollama/ollama:latest AS final
WORKDIR /app

# Copy Node runtime from an official Node image (gleiche Arch wie Target durch buildx)
COPY --from=node:20-bullseye-slim /usr/local/bin/node /usr/local/bin/node
COPY --from=node:20-bullseye-slim /usr/local/lib/node_modules /usr/local/lib/node_modules
RUN ln -s /usr/local/lib/node_modules/npm/bin/npm-cli.js /usr/local/bin/npm \
 && ln -s /usr/local/lib/node_modules/npm/bin/npx-cli.js /usr/local/bin/npx || true

# Copy standalone build output (inkl. bereits gebauter native Module)
COPY --from=builder /build/ollama-ui/.next/standalone ./
COPY --from=builder /build/ollama-ui/.next/static ./.next/static
COPY --from=builder /build/ollama-ui/public ./public

# Sicherheits-Rebuild von better-sqlite3 im finalen Image, falls QEMU/emulation Abweichungen erzeugt hat
RUN if [ -d node_modules ]; then \
  FOUND=$(find . -type d -path '*/better-sqlite3' | head -n1 || true); \
  if [ -n "$FOUND" ]; then \
    echo '[info] Rebuilding better-sqlite3 in final image'; \
    cd "$FOUND" && npm install node-gyp -g >/dev/null 2>&1 || true; \
    node-gyp rebuild || echo '[warn] better-sqlite3 rebuild failed (continuing)'; \
  else \
    echo '[info] better-sqlite3 directory not found for rebuild'; \
  fi; \
fi

# Environment variables
ENV OLLAMA_HOST="http://localhost:11434" \
    NODE_ENV=production \
    PORT=3000

# Start script
COPY <<'EOF' /app/start.sh
#!/usr/bin/env bash
set -euo pipefail

echo "[start] launching ollama server" >&2
ollama serve &
OLLAMA_PID=$!

sleep 2

if [ -f server.js ]; then
  echo "[start] launching Next.js UI on port ${PORT}" >&2
  exec node server.js
else
  echo "[error] server.js not found in /app. Did the build step succeed?" >&2
  kill ${OLLAMA_PID} || true
  exit 1
fi
EOF

RUN chmod +x /app/start.sh

EXPOSE 11434 3000

HEALTHCHECK --interval=30s --timeout=5s --retries=5 CMD bash -c 'exec 3<>/dev/tcp/127.0.0.1/3000 && echo -e "GET / HTTP/1.0\n\n" >&3 && grep -q "200" <(sleep 1; cat <&3)'

ENTRYPOINT ["/app/start.sh"]
